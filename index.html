<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="index.css" />
  <link rel="icon" href="./favicon.ico" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
    rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
</head>

<body>
  <p id="subs"></p>
  <div id="startup">
    <img id="startLogo" src="images/logo_white.png">
    <div id="startText">
      <h1>Workplace Guardian</h1>
      <p>Supporting a Safer, Healthier Deloitte Workplace</p>
      <button id="newBtn">Get Started<div id="loader"></div></button>
      <button id="startBtn">Load Wayne</button>
    </div>
    <img id="cutImg" src="images/smiley_cut.png">
  </div>
  <div id="main" style="display: none;">
    <p style="display:none;" id="badcode">beginning</p>
    <video class="bigVid" id="mediaElement" autoplay></video>


    <div id="statusBlock">
      <label>
        Avatar ID (v3)
        <input id="avatarID" type="text" placeholder="Paste your v3 Interactive Avatar ID" value="June_HR_public" />
      </label>

      <label>
        Voice ID (optional)
        <input id="voiceID" type="text" placeholder="e.g. Monica"/>
      </label>

      <label for="languageDrop">
        <select name="languageDrop" id="languageDrop">
          <option value="Chinese">ä¸­æ–‡</option>
          <option value="English">English</option>
          <option value="Japanese">æ—¥æ–‡</option>
          <option value="German">Deutsch</option>
          <option value="French">FranÃ§ais</option>
          <option value="Spanish">EspaÃ±ol</option>
          <option value="Italian">Italiano</option>
        </select>
      </label>
      <input id="taskInput" placeholder="ä½ å¥½ï¼Œä½ ä»Šå¤©æƒ³èŠäº›ä»€éº¼ï¼Ÿ" type="text" />
      <button id="speachBtn"><img id="spchImg" src="images/speech.png"></button>
      <button id="endSpeech"><img style="width: 5vw;" src="images/stap.png" /></button>
      <button id="talkBtn"><img style="width: 5vw;" src="images/send_white.png" /></button>
      <button id="resetBtn" title="é‡æ–°é–‹å§‹å°è©±">ğŸ”„</button>
      <button style="display: none;" id="repeatBtn">Repeat</button>
      <button style="display: none;" id="closeBtn">Repeat</button>
    </div>

    <p style="color: yellow; background-color: rgb(0,0,0,0.3); padding: 0.5vw;" id="status"></p>
    <p style="color: white; background-color: rgb(0,0,0,0.5); padding: 0.3vw; font-size: 0.8em; position: absolute; bottom: 10px; right: 10px;"
      id="spaceKeyHint">Hold SPACE to talk</p>

    <div id="qrBlock">
      <h1>Scan to access Deloitte's career website</h1>
      <!-- <div id="qrCode"></div> -->
    </div>
  </div>

  <script type="module" src="index.js"></script>
  <!-- <script type="module" src="qrcode.js"></script> -->
  <script>
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();

    //determines recognition language based on dropdown selection
    var selector = document.getElementById("languageDrop");
    var selectedLang = selector.value;
    recognition.lang = "zh-TW";
    recognition.continuous = true;
    var transStore = [];

    selector.addEventListener("change", function () {
      var selectedLang = this.value;
      console.log(selectedLang);
      if (selectedLang == "Chinese") {
        recognition.lang = "zh-TW";
        taskInput.placeholder = "ä½ å¥½ï¼Œä½ ä»Šå¤©æƒ³èŠäº›ä»€éº¼ï¼Ÿ"
      }
      if (selectedLang == "English") {
        recognition.lang = "en-US";
        taskInput.placeholder = "Hello, what would you like to talk about today?"
      }
      if (selectedLang == "Japanese") {
        recognition.lang = "ja";
        taskInput.placeholder = "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ä½•ã‚’è©±ã—ãŸã„ã§ã™ã‹ï¼Ÿ"
      }
      if (selectedLang == "German") {
        recognition.lang = "de";
        taskInput.placeholder = "Hallo, worÃ¼ber mÃ¶chtest du heute sprechen?"
      }
      if (selectedLang == "French") {
        recognition.lang = "fr";
        taskInput.placeholder = "Bonjour, de quoi veux-tu parler aujourd'hui ?"
      }
      if (selectedLang == "Italian") {
        recognition.lang = "it";
        taskInput.placeholder = "Ciao, di cosa vuoi parlare oggi?"
      }
      if (selectedLang == "Spanish") {
        recognition.lang = "es";
        taskInput.placeholder = "Hola, Â¿de quÃ© te gustarÃ­a hablar hoy?"
      }
    });



    const startButton = document.getElementById('speachBtn');
    const taskInput = document.getElementById('taskInput');
    const talkBtn = document.getElementById('talkBtn');
    const endBtn = document.getElementById('endSpeech');
    const resetBtn = document.getElementById('resetBtn');
    recognition.onstart = () => {
      startButton.textContent = 'Listening...';
    };

    recognition.onresult = (event) => {
      const transcript = event.results[event.resultIndex][0].transcript;
      transStore.push(transcript);
    };

    recognition.onend = () => {
      startButton.textContent = 'Start Voice Input';
      let allTrans = "";
      for (let i = 0; i < transStore.length; i++) {
        allTrans += transStore[i];
      }
      taskInput.value = allTrans;
      talkBtn.click();
      console.log(allTrans);
      transStore = []
    };

    startButton.addEventListener('click', () => {
      recognition.start();
      endBtn.style.display = "initial";
      startButton.style.display = "none";
    });

    endBtn.addEventListener('click', () => {
      recognition.stop();
      endBtn.style.display = "none";
      startButton.style.display = "initial";
    });

    // é‡ç½®å°è©±åŠŸèƒ½
    resetBtn.addEventListener('click', async ()=>{
      try {
        const response = await fetch('http://localhost:3000/openai/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('Conversation reset:', data.message);
          // æ¸…ç©ºè¼¸å…¥æ¡†
          taskInput.value = '';
          // å¯ä»¥æ·»åŠ è¦–è¦ºåé¥‹
          resetBtn.textContent = 'âœ…';
          setTimeout(() => {
            resetBtn.textContent = 'ğŸ”„';
          }, 1000);
        } else {
          console.error('Failed to reset conversation');
        }
      } catch (error) {
        console.error('Error resetting conversation:', error);
      }
    })

    let typing = false;
    let spaceKeyPressed = false;

    //stuff that hides stuff
    addEventListener("keydown", function (e) {
      // é˜²æ­¢åœ¨è¼¸å…¥æ¡†ä¸­æŒ‰ç©ºç™½éµæ™‚è§¸ç™¼èªéŸ³åŠŸèƒ½
      if (e.target === taskInput) {
        // å¦‚æœç„¦é»åœ¨è¼¸å…¥æ¡†ä¸Šï¼Œåªè™•ç† Enter éµ
        if (typing == true && e.key == "Enter") {
          talkBtn.click();
        }
        return;
      }

      //æŒ‰ä½ç©ºç™½éµé–‹å§‹èªéŸ³è¼¸å…¥ï¼ˆåªåœ¨å°è©±ç•«é¢ä¸­æœ‰æ•ˆï¼‰
      if (e.key == " " && !spaceKeyPressed && document.getElementById("main").style.display !== "none") {
        e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
        spaceKeyPressed = true;
        startButton.click();
      }

      //lets user start talking by pressing the "1" key
      if (e.key == "1") {
        startButton.click();
      }

      //lets user click the 'end speech' button by pressing the "2" key
      if (e.key == "2") {
        endBtn.click();
      }

      //lets user hide the status bar by pressing the "3" key
      if (e.key == "3") {
        var statusBlock = document.getElementById("statusBlock");
        var leftButtons = document.getElementById("leftButtons");
        if (statusBlock.style.display != "none" && leftButtons.style.display != "none") {
          statusBlock.style.display = "none";
          leftButtons.style.display = "none";
        }
        else {
          statusBlock.style.display = "flex";
          leftButtons.style.display = "initial";
        }
      }

      //let's the user input stuff via the Enter button if typing
      if (typing == true && e.key == "Enter") {
        talkBtn.click();
      }
    });

    //æ”¾é–‹ç©ºç™½éµåœæ­¢èªéŸ³è¼¸å…¥
    addEventListener("keyup", function (e) {
      if (e.key == " " && spaceKeyPressed && document.getElementById("main").style.display !== "none") {
        e.preventDefault();
        spaceKeyPressed = false;
        endBtn.click();
      }
    });

    //deals with transitions between send text, speech, and stop speech buttons
    taskInput.addEventListener("input", () => {
      if (taskInput.value == "") {
        talkBtn.style.display = "none";
        startButton.style.display = "initial";
        typing = false;
      }
      else {
        talkBtn.style.display = "initial";
        startButton.style.display = "none";
        typing = true;
      }
    })




    //loads Wayne when new button "get started" is pressed
    document.getElementById('newBtn').addEventListener("click", () => {
      document.getElementById("newBtn").innerHTML = "Starting Up<div id='loader'></div>";
      document.getElementById("loader").style.display = "initial";
    });

    // ç¢ºä¿ç©ºç™½éµæç¤ºåªåœ¨å°è©±ç•«é¢é¡¯ç¤º
    const spaceKeyHint = document.getElementById('spaceKeyHint');
    const mainDiv = document.getElementById('main');
    const startupDiv = document.getElementById('startup');

    // ç›£è½ç•«é¢åˆ‡æ›
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          if (mainDiv.style.display === 'none') {
            spaceKeyHint.style.display = 'none';
          } else {
            spaceKeyHint.style.display = 'block';
          }
        }
      });
    });

    observer.observe(mainDiv, { attributes: true });

    // åˆå§‹ç‹€æ…‹éš±è—æç¤º
    spaceKeyHint.style.display = 'none';

  </script>
</body>

</html>
